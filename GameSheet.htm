<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CharacterSheet - LegendsOfMyradon</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="icon" href="data:;base64,iVBORwOKGO=" />

    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.3.1.min.js" crossorigin="anonymous" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>
    <script type="text/javascript" src="Library.js"></script>
    <script type="text/javascript" src="GameOptions.js"></script>

    <script type="text/javascript">

        var accountObj = FetchAccountObj();
        var currentGame = null;

        // todo, clean up to fetch method, redirect if null, the method to set vals, another to load grid....
        $(document).ready(function () {
            var id = getUrlParameter("id");
            currentGame = FindGameInAcctObjById(accountObj, id).gameObj;
            if (currentGame == null) {
                window.location = "Index.htm?badGame=" + id;
                return;
            }

            SetUpHeroGrid();
        });

        function SetUpHeroGrid() {
            // Game name, other details
            $("#gameNameHeading h2 span").html(currentGame.name);

            // Setup the hero drop down selector (once before per-hero cloning)
            var allHeroes = GetHeroChoices();
            var heroDDL = $("#row_heroName select");
            for (var i = 0; i < allHeroes.length; i++) {
                var hero = allHeroes[i];
                heroDDL.append("<option>" + hero.name + "</option>");
            }

            // If this is a new game, select some defaults

            // Construct elements based on number of heroes
            var numberOfHeroes = currentGame.heroCount;
            var headTr = $("#heroDetails thead tr").eq(0);
            for (var i = 1; i <= numberOfHeroes; i++) {
                var isRed = i % 2 != 0;
                headTr.append("<th>" + (isRed ? "Red" : "Blue") + "Hero #" + i + "</th>");
            }
            $("#heroDetails tbody tr").each(function () {
                var tr = $(this);
                var targetTd = tr.find("td").eq(1);
                for (var i = 1; i <= numberOfHeroes; i++) {
                    var clonedTd = targetTd.clone();
                    clonedTd.find("input, select, textarea").each(function () {
                        if (!!$(this).attr("id")) {
                            var id = $(this).attr("id");
                            $(this).attr("id", id.replace("heroTick", i));
                        }
                    });
                    tr.append(clonedTd);
                }
                targetTd.remove();
            });

            // Pushed saved game data to elements, or push the starting-game defaults.
            if (!!currentGame.savedItems) {
                var segments = currentGame.savedItems.split("&");
                for (var i = 0; i < segments.length; i++) {
                    var segment = segments[i].split("=");
                    var keyName = segment[0];
                    var keyValue = segment[1];
                    if (!keyName) {
                        console.log("Bad key name from segment: " + segments[i]);
                        continue;
                    }
                    $("#" + keyName).val(keyValue);
                }
            }
            else {
                $("#row_heroLvl input").val("1");
                $("#row_heroExp input").val("0");
                $("#row_heroNextExp input").val("2");
            }
            
        }

        function EndRound() {
            var tbl = $("#cooldownTbl");
            tbl.find("tbody tr").each(function () {
                var textInput = $(this).find("td").eq(0).find("input");
                var text = textInput.val();
                var countDownInput = $(this).find("td").eq(1).find("input");
                var countDownVal = countDownInput.val();
                if (!!text) {
                    var count = parseInt(countDownVal);
                    console.log(count + " " + countDownVal);
                    if (isNaN(count)) {
                        alert("Bad countdown: " + countDownVal);
                        return;
                    }
                    if (count == 0) {
                        countDownInput.val("");
                        textInput.val("");
                    }
                    else {
                        count -= 1;
                        countDownInput.val(count);
                    }
                }
            });
        }

        function SaveGame() {

            function ConvertIdsToNameAttribs(form) {
                $(form).find("input, select, textarea").each(function () {
                    var item = $(this);
                    if (!!item.attr("name") || !item.attr("id"))
                        return;

                    item.attr("name", item.attr("id"));
                    item.attr("data-dynamic-name", true);
                });
            }

            function RemoveNameAttribs(form) {
                $(form).find("*[data-dynamic-name]").each(function () {
                    $(this).removeAttr("data-dynamic-name");
                });
            }

            var dataForm = $("#charsheetWrapper form");
            ConvertIdsToNameAttribs(dataForm);
            // keep original text of inputs
            var savedItems = decodeURIComponent(dataForm.serialize().replace(/%2F/g, " "));
            currentGame.savedItems = savedItems;
            UpdateAccountObj(accountObj);

            RemoveNameAttribs(dataForm);
        }

    </script>

    <style>
        #gameNameHeading {
            background-color: #efefef;
            padding: 5px 4px;
            margin: 0 0 8px 0;
        }
    </style>
</head>
<body>

    <div class="mainPageWrapper">

        <header>
            <h1>Heroes of Myradon</h1>
            <a href="Calc.htm">Calculator</a>
            <a href="Index.htm">Home</a>
        </header>

        <div id="charsheetWrapper">

            <form onsubmit="SaveGame(); return false;">

                <div id="gameNameHeading">
                    <h2>
                        Current Game: 
                        <span></span> 
                        &nbsp;&nbsp;<input type="submit" class="saveBtn" value="Save Game" />
                    </h2>
                </div>

                <div style="float: right;">
                    <table style="margin: 0 0 20px 0;" id="cooldownTbl">
                        <thead>
                            <tr>
                                <th>Countdown</th>
                                <th>Rounds</th>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" /></td>
                                <td><input type="number" min="0" max="20" /></td>
                            </tr>
                            <tr>
                                <td><input type="text" /></td>
                                <td><input type="number" min="0" max="20" /></td>
                            </tr>
                            <tr>
                                <td><input type="text" /></td>
                                <td><input type="number" min="0" max="20" /></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <button onclick="EndRound(); return false;">End Round</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!--<h3>Towers</h3>-->

                    <table>
                        <tr>
                            <th></th>
                            <th>Red Side</th>
                            <th>Blue Side</th>
                        </tr>
                        <tr>
                            <td>Top Tower</td>
                            <td><input class="smallNumber" type="text" id="p1_Ott" /></td>
                            <td><input class="smallNumber" type="text" id="p2_Ott" /></td>
                        </tr>
                        <tr>
                            <td>Middle Tower</td>
                            <td><input class="smallNumber" type="text" id="p1_Otm" /></td>
                            <td><input class="smallNumber" type="text" id="p2_Otm" /></td>
                        </tr>
                        <tr>
                            <td>Bottom Tower</td>
                            <td><input class="smallNumber" type="text" id="p1_Otb" /></td>
                            <td><input class="smallNumber" type="text" id="p2_Otb" /></td>
                        </tr>
                        <tr>
                            <td>Top Minion #1</td>
                            <td><input class="smallNumber" type="text" id="p1_TopMin1" /></td>
                            <td><input class="smallNumber" type="text" id="p2_TopMin1" /></td>
                        </tr>
                        <tr>
                            <td>Top Minion #2</td>
                            <td><input class="smallNumber" type="text" id="p1_TopMin2" /></td>
                            <td><input class="smallNumber" type="text" id="p2_TopMin2" /></td>
                        </tr>
                        <tr>
                            <td>Middle Minion #1</td>
                            <td><input class="smallNumber" type="text" id="p1_MidMin1" /></td>
                            <td><input class="smallNumber" type="text" id="p2_MidMin1" /></td>
                        </tr>
                        <tr>
                            <td>Middle Minion #2</td>
                            <td><input class="smallNumber" type="text" id="p1_MidMin2" /></td>
                            <td><input class="smallNumber" type="text" id="p2_MidMin2" /></td>
                        </tr>
                        <tr>
                            <td>Bottom Minion #1</td>
                            <td><input class="smallNumber" type="text" id="p1_BotMin1" /></td>
                            <td><input class="smallNumber" type="text" id="p2_BotMin1" /></td>
                        </tr>
                        <tr>
                            <td>Bottom Minion #2</td>
                            <td><input class="smallNumber" type="text" id="p1_BotMin2" /></td>
                            <td><input class="smallNumber" type="text" id="p2_BotMin2" /></td>
                        </tr>
                    </table>


                </div>

                <table id="heroDetails">
                    <thead>
                        <tr><th></th></tr>
                    </thead>
                    <tbody>
                        <tr id="row_heroName">
                            <td>Character</td>
                            <td>
                                <select id="heroName_heroTick"><option>---</option></select>
                            </td>
                        </tr>
                        <tr id="row_heroLvl">
                            <td>Char. Level</td>
                            <td><input type="number" id="heroLvl_heroTick" min="1" max="11" /></td>
                        </tr>
                        <tr id="row_heroExp">
                            <td>Current Exp</td>
                            <td><input type="number" id="heroExp_heroTick" min="0" max="30" /></td>
                        </tr>
                        <tr id="row_heroNextExp">
                            <td>Exp for next level</td>
                            <td><input type="number" id="heroNextExp_heroTick" min="0" max="30" /></td>
                        </tr>
                        <tr id="row_heroBaseDmg">
                            <td>Base dmg</td>
                            <td><input type="text" id="heroBaseDmg_heroTick" /></td>
                        </tr>
                        <tr id="row_heroMvmt">
                            <td>Movement</td>
                            <td><input type="number" id="heroMvmt_heroTick" min="0" max="30" /></td>
                        </tr>
                        <tr id="row_heroCurrHealth">
                            <td>Currant health</td>
                            <td><input type="number" id="heroCurrHealth_heroTick" /></td>
                        </tr>
                        <tr id="row_heroMaxHealth">
                            <td>Max health</td>
                            <td><input type="number" id="heroMaxHealth_heroTick" /></td>
                        </tr>
                        <tr id="row_heroCurrMana">
                            <td>Current mana</td>
                            <td><input type="number" id="heroCurrMana_heroTick" /></td>
                        </tr>
                        <tr id="row_heroMaxMana">
                            <td>Max mana</td>
                            <td><input type="number" id="heroMaxMana_heroTick" /></td>
                        </tr>
                        <tr id="row_heroPozMods">
                            <td>Positive mods</td>
                            <td><input type="text" id="heroPozMods_heroTick" /></td>
                        </tr>
                        <tr id="row_heroNegMods">
                            <td>Negative mods</td>
                            <td><input type="text" id="heroNegMods_heroTick" /></td>
                        </tr>
                        <tr id="row_heroDodge">
                            <td>Dodge Chance</td>
                            <td><input type="text" id="heroDodge_heroTick" /></td>
                        </tr>
                    </tbody>
                </table>

            </form>

        </div>

    </div>

</body>
</html>
