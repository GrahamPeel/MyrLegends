<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CharacterSheet - LegendsOfMyradon</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="icon" href="data:;base64,iVBORwOKGO=" />

    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.3.1.min.js" crossorigin="anonymous" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>
    <script type="text/javascript" src="Library.js"></script>

    <script type="text/javascript">
        function EndRound() {
            var tbl = $("#cooldownTbl");
            tbl.find("tbody tr").each(function () {
                var textInput = $(this).find("td").eq(0).find("input");
                var text = textInput.val();
                var countDownInput = $(this).find("td").eq(1).find("input");
                var countDownVal = countDownInput.val();
                if (!!text) {
                    var count = parseInt(countDownVal);
                    console.log(count + " " + countDownVal);
                    if (isNaN(count)) {
                        alert("Bad countdown: " + countDownVal);
                        return;
                    }
                    if (count == 0) {
                        countDownInput.val("");
                        textInput.val("");
                    }
                    else {
                        count -= 1;
                        countDownInput.val(count);
                    }
                }
            });
        }

        function ConvertIdsToNameAttribs(form) {
            $(form).find("input, select, textarea").each(function () {
                var item = $(this);
                if (!!item.attr("name") || !item.attr("id"))
                    return;

                item.attr("name", item.attr("id"));
                item.attr("data-dynamic-name", true);
                //console.log(item);
            });
        }

        function RemoveNameAttribs(form) {
            $(form).find("*[data-dynamic-name]").each(function () {
                $(this).removeAttr("data-dynamic-name");
            });
        }

        function SaveGame() {
            var dataForm = $("#charsheetWrapper form");
            ConvertIdsToNameAttribs(dataForm);
            // keep original text of inputs
            var savedItems = decodeURIComponent(dataForm.serialize().replace(/%2F/g, " ")); 
            var savedGame = GetGameObj();
            savedGame.savedItems = savedItems;
            SaveGameObj(savedGame);
            RemoveNameAttribs(dataForm);
        }

        function LoadSavedGame() {
            var savedGame = GetGameObj();
            if (savedGame != null) {
                return savedGame;
            }
            else {
                window.location = "Index.htm";
            }
        }

        function SetUpHeroGrid(game) {
            console.log(game);
            var numberOfHeroes = game.heroCount;

            var headTr = $("#heroDetails thead tr").eq(0);
            for (var i = 1; i <= numberOfHeroes; i++) {
                var isRed = i % 2 != 0;
                headTr.append("<th>" + (isRed ? "Red" : "Blue") + "Hero #" + i + "</th>");
            }
            $("#heroDetails tbody tr").each(function () {
                var tr = $(this);
                var targetTd = tr.find("td").eq(1);
                for (var i = 1; i <= numberOfHeroes; i++) {
                    var clonedTd = targetTd.clone();
                    clonedTd.find("input, select, textarea").each(function () {
                        if (!!$(this).attr("id")) {
                            var id = $(this).attr("id");
                            $(this).attr("id", id.replace("{heroTick}", i));
                        }
                    });
                    tr.append(clonedTd);
                }
                targetTd.remove();
            });

            var segments = game.savedItems.split("&");
            for (var i = 0; i < segments.length; i++) {
                var segment = segments[i].split("=");
                var keyName = segment[0];
                var keyValue = segment[1];
                if (!keyName) {
                    console.log("Bad key name from segment: " + segments[i]);
                    continue;
                }
                $("#" + keyName).val(keyValue);
            }
        }

        // todo, clean up to fetch method, redirect if null, the method to set vals, another to load grid....
        $(document).ready(function () {
            var game = LoadSavedGame();
            SetUpHeroGrid(game);
        });

    </script>
    <style>
        #charsheetWrapper form {
            position: relative;
        }

            #charsheetWrapper form .saveBtn {
                /*position: absolute;
                bottom: 0;
                right: 0;*/
                display: block;
                margin: 20px 0 0 0;
            }
    </style>
</head>
<body>

    <div class="mainPageWrapper">

        <header>
            <h1>Heroes of Myradon</h1>
            <a href="Calc.htm">Calculator</a>
            <a href="GameSheet.htm">Game Sheet</a>
            <a href="Index.htm">Home</a>
        </header>

        <div id="charsheetWrapper">

            <form onsubmit="SaveGame(); return false;"> 

                <div style="float: right;">
                    <h3>Cooldown Counter <button onclick="EndRound(); return false;">End Round</button></h3>
                    <table style="margin: 0 0 50px 0;" id="cooldownTbl">
                        <thead>
                            <tr>
                                <th>Effect</th>
                                <th>Countdown</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" /></td>
                                <td><input type="number" min="0" max="20" /></td>
                            </tr>
                            <tr>
                                <td><input type="text" /></td>
                                <td><input type="number" min="0" max="20" /></td>
                            </tr>
                            <tr>
                                <td><input type="text" /></td>
                                <td><input type="number" min="0" max="20" /></td>
                            </tr>
                        </tbody>
                    </table>

                    <!--<h3>Towers</h3>-->

                    <table>
                        <tr>
                            <th></th>
                            <th>Red Side</th>
                            <th>Blue Side</th>
                        </tr>
                        <tr>
                            <td>Top Tower</td>
                            <td><input type="text" id="p1_Ott" /></td>
                            <td><input type="text" id="p2_Ott" /></td>
                        </tr>
                        <tr>
                            <td>Middle Tower</td>
                            <td><input type="text" id="p1_Otm" /></td>
                            <td><input type="text" id="p2_Otm" /></td>
                        </tr>
                        <tr>
                            <td>Bottom Tower</td>
                            <td><input type="text" id="p1_Otb" /></td>
                            <td><input type="text" id="p2_Otb" /></td>
                        </tr>
                        <tr>
                            <td>Top Minion #1</td>
                            <td><input type="text" id="p1_TopMin1" /></td>
                            <td><input type="text" id="p2_TopMin1" /></td>
                        </tr>
                        <tr>
                            <td>Top Minion #2</td>
                            <td><input type="text" id="p1_TopMin2" /></td>
                            <td><input type="text" id="p2_TopMin2" /></td>
                        </tr>
                        <tr>
                            <td>Middle Minion #1</td>
                            <td><input type="text" id="p1_MidMin1" /></td>
                            <td><input type="text" id="p2_MidMin1" /></td>
                        </tr>
                        <tr>
                            <td>Middle Minion #2</td>
                            <td><input type="text" id="p1_MidMin2" /></td>
                            <td><input type="text" id="p2_MidMin2" /></td>
                        </tr>
                        <tr>
                            <td>Bottom Minion #1</td>
                            <td><input type="text" id="p1_BotMin1" /></td>
                            <td><input type="text" id="p2_BotMin1" /></td>
                        </tr>
                        <tr>
                            <td>Bottom Minion #2</td>
                            <td><input type="text" id="p1_BotMin2" /></td>
                            <td><input type="text" id="p2_BotMin2" /></td>
                        </tr>
                    </table>


                </div>

                <table id="heroDetails">
                    <thead>
                        <tr><th></th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Character</td>
                            <td><input type="text" id="hero_{heroTick}" /></td>
                            <!--<td><input type="text" id="i2_Name" /></td>
                            <td><input type="text" id="i3_Name" /></td>
                            <td><input type="text" id="i4_Name" /></td>-->
                        </tr>

                        <tr>
                            <td>Char. Level</td>
                            <td><input type="number" id="heroLvl_{heroTick}" min="1" max="11" /></td>
                            <!--<td><input type="number" id="i2_CharLvl" min="1" max="11" /></td>
                            <td><input type="number" id="i3_CharLvl" min="1" max="11" /></td>
                            <td><input type="number" id="i4_CharLvl" min="1" max="11" /></td>-->
                        </tr>
                        <tr>
                            <td>Current Exp</td>
                            <td><input type="number" id="heroExp_{heroTick}" min="0" max="30" /></td>
                            <!--<td><input type="number" id="i2_CurrExp" min="0" max="30" /></td>
                            <td><input type="number" id="i3_CurrExp" min="0" max="30" /></td>
                            <td><input type="number" id="i4_CurrExp" min="0" max="30" /></td>-->
                        </tr>
                        <tr>
                            <td>Exp for next level</td>
                            <td><input type="number" id="heroNextExp_{heroTick}" min="0" max="30" /></td>
                            <!--<td><input type="number" id=i2_NextExp min="0" max="30" /></td>
                            <td><input type="number" id=i3_NextExp min="0" max="30" /></td>
                            <td><input type="number" id=i4_NextExp min="0" max="30" /></td>-->
                        </tr>
                        <tr>
                            <td>Base dmg</td>
                            <td><input type="text" id="heroBaseDmg_{heroTick}" /></td>
                            <!--<td><input type="text" id="i2_BaseDmg" /></td>
                            <td><input type="text" id="i3_BaseDmg" /></td>
                            <td><input type="text" id="i4_BaseDmg" /></td>-->
                        </tr>
                        <tr>
                            <td>Movement</td>
                            <td><input type="number" id="heroMvmt_{heroTick}" min="0" max="30" /></td>
                            <!--<td><input type="number" id="i2_Movement" min="0" max="30" /></td>
                            <td><input type="number" id="i3_Movement" min="0" max="30" /></td>
                            <td><input type="number" id="i4_Movement" min="0" max="30" /></td>-->
                        </tr>
                        <tr>
                            <td>Currant health</td>
                            <td><input type="number" id="heroCurrHealth_{heroTick}" /></td>
                            <!--<td><input type="number" id="i2_CurrHealth" /></td>
                            <td><input type="number" id="i3_CurrHealth" /></td>
                            <td><input type="number" id="i4_CurrHealth" /></td>-->
                        </tr>
                        <tr>
                            <td>Max health</td>
                            <td><input type="number" id="heroMaxHealth_{heroTick}" /></td>
                            <!--<td><input type="number" id="i2_MaxHealth" /></td>
                            <td><input type="number" id="i3_MaxHealth" /></td>
                            <td><input type="number" id="i4_MaxHealth" /></td>-->
                        </tr>
                        <tr>
                            <td>Current mana</td>
                            <td><input type="number" id="heroCurrMana_{heroTick}" /></td>
                            <!--<td><input type="number" id="i2_CurrMana" /></td>
                            <td><input type="number" id="i3_CurrMana" /></td>
                            <td><input type="number" id="i4_CurrMana" /></td>-->
                        </tr>
                        <tr>
                            <td>Max mana</td>
                            <td><input type="number" id="heroMaxMana_{heroTick}" /></td>
                            <!--<td><input type="number" id="i2_MaxMana" /></td>
                            <td><input type="number" id="i3_MaxMana" /></td>
                            <td><input type="number" id="i4_MaxMana" /></td>-->
                        </tr>
                        <tr>
                            <td>Positive mods</td>
                            <td><input type="text" id="heroPozMods_{heroTick}" /></td>
                            <!--<td><input type="text" id="i2_PozMods" /></td>
                            <td><input type="text" id="i3_PozMods" /></td>
                            <td><input type="text" id="i4_PozMods" /></td>-->
                        </tr>
                        <tr>
                            <td>Negative mods</td>
                            <td><input type="text" id="heroNegMods_{heroTick}" /></td>
                            <!--<td><input type="text" id="i2_NegMods" /></td>
                            <td><input type="text" id="i3_NegMods" /></td>
                            <td><input type="text" id="i4_NegMods" /></td>-->
                        </tr>
                        <tr>
                            <td>Dodge Chance</td>
                            <td><input type="text" id="heroDodge_{heroTick}" /></td>
                            <!--<td><input type="text" id="i2_Dodge" /></td>
                            <td><input type="text" id="i3_Dodge" /></td>
                            <td><input type="text" id="i4_Dodge" /></td>-->
                        </tr>
                    </tbody>
                </table>

                <input type="submit" class="saveBtn" value="Save Game" />

            </form>

        </div>

    </div>

</body>
</html>
